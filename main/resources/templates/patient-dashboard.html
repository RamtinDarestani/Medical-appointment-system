<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>داشبورد بیمار</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      color: #333;
      margin-bottom: 20px;
    }

    .doctor-item {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      background-color: #fff;
      transition: all 0.3s ease;
    }

    .doctor-item:hover {
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .doctor-item h3 {
      margin: 0 0 10px 0;
      color: #2c3e50;
    }

    .doctor-item p {
      margin: 5px 0;
      color: #666;
    }

    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #2980b9;
    }

    #status {
      margin-bottom: 20px;
      padding: 10px;
      border-radius: 4px;
    }

    .error {
      background-color: #fee;
      color: #c0392b;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>لیست دکترها</h2>
  <div id="status"></div>
  <div th:if="${appointment != null && appointment.paymentStatus == 'PENDING'}" class="payment-section">
    <a th:href="@{/payment/{id}(id=${appointment.id})}"
       class="btn btn-primary">پرداخت</a>
  </div>
  <div id="doctorList"></div>
</div>

<script>
  function updateStatus(message, isError = false) {
    const status = document.getElementById('status');
    status.textContent = message;
    status.className = isError ? 'error' : '';
  }

  document.addEventListener('DOMContentLoaded', function () {
    console.log('Page loaded');

    const patientId = localStorage.getItem('patientId');
    console.log('Patient ID from localStorage:', patientId);

    if (!patientId) {
      console.log('No patient ID found - redirecting to login');
      updateStatus('لطفاً ابتدا وارد شوید', true);
      window.location.href = '/patient-login.html';
      return;
    }

    console.log('Starting to fetch doctors...');
    updateStatus('در حال دریافت لیست دکترها...');

    const doctorList = document.getElementById('doctorList');
    console.log('Doctor list element:', doctorList);

    fetch('http://localhost:8080/api/doctors', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      credentials: 'include'
    })
            .then(response => {
              console.log('Raw response:', response);
              console.log('Response status:', response.status);
              console.log('Response headers:', Array.from(response.headers.entries()));

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(doctors => {
              console.log('Doctors data:', doctors);

              if (!doctorList) {
                throw new Error('Doctor list element not found');
              }

              if (!Array.isArray(doctors)) {
                throw new Error('Received invalid doctors data');
              }

              if (doctors.length === 0) {
                updateStatus('هیچ دکتری یافت نشد');
                doctorList.innerHTML = '<p>هیچ دکتری در سیستم ثبت نشده است.</p>';
              } else {
                updateStatus(`${doctors.length} دکتر یافت شد`);
                doctors.forEach(doctor => {
                  const doctorElement = document.createElement('div');
                  doctorElement.className = 'doctor-item';
                  doctorElement.innerHTML = `
                            <h3>${doctor.name || 'نام نامشخص'}</h3>
                            <p>تخصص: ${doctor.specialization || 'نامشخص'}</p>
                            <button onclick="viewAvailability(${doctor.id})">مشاهده زمان‌های خالی</button>
                        `;
                  doctorList.appendChild(doctorElement);
                });
              }
            })
            .catch(error => {
              console.error('Detailed error:', error);
              updateStatus(`خطا در دریافت لیست دکترها: ${error.message}`, true);
            });
  });

  function viewAvailability(doctorId) {
    console.log('Viewing availability for doctor:', doctorId);
    window.location.href = `/doctor-availability.html?doctorId=${doctorId}`;
  }
</script>
</body>
</html>